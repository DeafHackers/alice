<!doctype html>
<html>
  <head>
    <title>Buttesfire</title>
    <script type="text/javascript" 
      src="http://ajax.googleapis.com/ajax/libs/prototype/1.6.0.2/prototype.js"></script>
    <script type="text/javascript">
      var filters = [
        function (content) {
          var filtered = content;
          // links
          filtered = filtered.replace(
            /(https?\:\/\/.+?)([\b\s<])/gi, "<a href=\"$1\" target=\"blank\">$1</a>$2");
          // images
          filtered = filtered.replace(
            /(<a[^>]*>)(.*?(:?jpg|jpeg|gif|png))/gi, "$1<img src=\"$2\" />");
          // audio
          filtered = filtered.replace(
            /(<a href=\"(.*?(:?wav|mp3|ogg|aiff)))/gi,
            "<img src=\"/static?f=play.png\" onclick=\"playAudio(this)\" class=\"audio\"/>$1");
          return filtered;
        }
      ];
      
      function applyFilters (content) {
        filters.each(function(filter) {
          content = filter(content);
        });
        return content;
      };
      
      function scrollToBottom () {
        window.scrollTo(0, document.height);
      }
      
      function showChannel (channel) {
        var oldchannel = $$('div.channel.active').first();
        oldchannel.removeClassName('active');
        $(oldchannel.id + "_tab").removeClassName('active');
        $(channel).addClassName('active');
        $(channel + "_tab").addClassName('active');
        $$('#tabs li').invoke('removeClassName', 'leftof_active');
        if ($(channel + "_tab").previous())
          $(channel + "_tab").previous().addClassName('leftof_active');
        scrollToBottom();
        $(channel + '_msg').focus();
      };
      
      function playAudio(image, audio) {
        console.log(audio);
        image.src = '/static?f=pause.png'; 
        if (! audio) {
            var url = image.nextSibling.href;
            audio = new Audio(url);
            console.log(audio);
            audio.addEventListener('ended', function () {
              image.src = '/static?f=play.png';
              image.onclick = function () { playAudio(image, audio) };
            });
        }
        audio.play();
        image.onclick = function() {
          audio.pause();
          this.src = '/static?f=play.png';
          this.onclick = function () { playAudio(this, audio) };
        };
      }
      
      function sayMessage (form) {
        new Ajax.Request('/say', {
          method: 'get',
          parameters: form.serialize(),
        });
        form.childNodes[3].value = '';
        return false;
      }
      
      document.observe('dom:loaded', function () {
        var len = 0;
        new Ajax.Request('/stream', {
          method: 'get',
          onInteractive: function (transport) {
            var data = transport.responseText.slice(len).evalJSON();
            len = transport.responseText.length;
            data.each(function(channel) {
              if (channel.html.length > 0) {
                $(channel.channel + '_messages').insert(applyFilters(channel.html));
                if ($(channel.channel).hasClassName('active'))
                  scrollToBottom();
              }
            })
          }
        });
      });
      window.onresize = scrollToBottom;
    </script>
    <style type="text/css">
      body {
        margin: 0;
        padding: 0;
        font-family: "Lucida Grande", Helvetica, sans-serif;
        background: #fff;
      }
      div.channel {
        display: none;
        position: relative;
        margin-top: 18px;
        margin-bottom: 54px;
      }
      div.channel.active {
        display: block;
      }
      ul.messages {
        list-style: none;
        margin: 0;
        padding: 0;
        background: #fff;
        overflow: hidden;
        overflow-y: auto;
      }
      div.input {
        position: fixed;
        bottom: 23px;
        left: 0px;
        height: 22px;
        width: 100%;
        padding-top: 6px;
        border-bottom: 2px solid #efefef;
        background: #efefef;
        border-top: 1px solid #aaa;
      }
      div.input input {
        width: 100%;
        height: 100%;
        padding: 3px 0;
        border: none;
        border-top: 1px solid #aaa;
        margin: 0;
        outline: 0 none;
      }
      ul#tabs {
        list-style: none;
        margin: 0;
        padding: 0;
        position: fixed;
        bottom: 0;
        left: 0;
        height: 22px;
        width: 100%;
        z-index: 999;
        font-size: 11px;
        border-top: 1px solid #999;
        background: #ddd;
      }
      ul#tabs li:first-child {
        margin-left: 3px;
      }
      ul#tabs li:first-child.active {
        border-left: 1px solid #999;
      }
      ul#tabs li {
        float: left;
        margin: 0;
        height: 14px;
        padding: 1px 8px 8px 8px;
        border: 1px solid #999;
        border-left: 1px solid transparent;
        border-bottom: none;
        color: #222;
        margin-top: -1px;
        background: #ddd;
      }
      ul#tabs li.active {
        border: 1px solid #999;
        border-top: 1px solid #efefef;
        background: #efefef;
        height: 10px;
        -webkit-border-bottom-left-radius: 2px;
        -webkit-border-bottom-right-radius: 2px;
        -moz-border-radius-bottomleft: 2px;
        -moz-border-radius-bottomright: 2px;
      }
      ul#tabs li.active:hover {
        background: #efefef;
      }
      ul#tabs li:hover {
        background: #ccc;
        cursor: default;
      }
      ul#tabs li.leftof_active {
        border-right: 1px solid transparent;
      }
      div.topic {
        position: fixed;
        top: 0px;
        left: 0px;
        width: 100%;
        background: #efefef;
        font-size: 11px;
        text-align: center;
        border-top: 1px solid #fff;
        border-bottom: 1px solid #aaa;
        padding: 1px 0;
        z-index: 998;
      }
      ul.messages li {
        border-bottom: 1px solid #eee;
        background: #efefef;
        font-size: 13px;
        clear: both;
      }
      div.nick {
        float: left;
        width: 120px;
        font-weight: bold;
        text-align: right;
        padding: 5px;
      }
      div.msg {
        margin-left: 131px;
        padding: 5px;
        border-right: 1px solid #ccc;
        background: #fff;
      }
      div.msg.monospace {
        font-family: Monaco, monospace;
        font-size: 11px;
      }
      img.audio {
        cursor: pointer;
        display: inline;
        padding: 0 4px;
        width: 16px;
        height: 16px;
        margin-bottom: -3px;
      }
    </style>
  </head>
  <body>
    <div class="topic" id="[% channel %]_topic">(no topic is set)</div>
    <ul id="tabs">
      [% FOR channel IN channels %]
      [% USE String(channel) %]
      [% channel = String.replace('#','') %]
      <li id="[% channel %]_tab"[% IF loop.first %] class="active"[% END %] onclick="showChannel('[% channel %]')">[% channel %]</li>
      [% END %]
    </ul>
    [% FOR channel IN channels %]
    [% USE String(channel) %]
    [% channel = String.replace('#','') %]
    <div class="channel[% IF loop.first %] active[% END %]" id="[% channel %]">
      <ul class="messages" id="[% channel %]_messages">
      </ul>
      <div class="input" id="[% channel %]_input">
        <form onsubmit="return sayMessage(this);" id="[% channel %]_form">
          <input type="hidden" name="chan" value="[% channel %]" />
          <input name="msg" id="[% channel %]_msg"/>
        </form>
      </div>
    </div>
    [% END %]
  </body>
</html>
